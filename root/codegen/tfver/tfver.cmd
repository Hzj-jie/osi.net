
setlocal

@echo off
call "%~dp0\..\init_vs_env.cmd"
echo.
echo 'this file is generated by /osi/root/codegen/tfver.cmd
echo 'so change the script instead of this file
echo.
echo Imports osi.root.constants
echo Imports osi.root.connector
echo.
echo Public Module _tfver
echo     Public ReadOnly tf_latest_changeset As String = _
set tf_ver=""
set tf_cur_ver=""
REM this script will be called by run.cmd from osi/root/codegen
if defined NO_TFVER (
    set tf_ver=""
) else (
	for /F "delims=" %%i in ('tf history ..\..\ /r /noprompt /stopafter:1 /version:T ^| findstr /v /i "changeset ---------"') do (
		set tf_ver="%%i" )
)
echo          %tf_ver%.Trim()
echo     Public ReadOnly tf_current_changeset As String = _
if defined NO_TFVER (
	set tf_cur_ver=""
) else (
	for /F "delims=" %%i in ('tf history ..\..\ /r /noprompt /stopafter:1 /version:W ^| findstr /v /i "changeset ---------"') do (
		set tf_cur_ver="%%i" )
)
echo          %tf_cur_ver%.Trim()
echo     Public ReadOnly tf_latest_changeset_id As String = "UNKNOWN"
echo     Public ReadOnly tf_latest_changeset_user As String = "UNKNOWN"
echo     Public ReadOnly tf_latest_changeset_date As String = "UNKNOWN"
echo     Public ReadOnly tf_latest_changeset_comment As String = "UNKNOWN"
echo.
echo     Public ReadOnly tf_current_changeset_id As String = "UNKNOWN"
echo     Public ReadOnly tf_current_changeset_user As String = "UNKNOWN"
echo     Public ReadOnly tf_current_changeset_date As String = "UNKNOWN"
echo     Public ReadOnly tf_current_changeset_comment As String = "UNKNOWN"
echo.
echo     Private Function next_token(ByRef i As String, ByRef s As String) As Boolean
echo         While strsep(i, s, i, character.blank)
echo             If Not String.IsNullOrEmpty(s) Then
echo                 Return True
echo             End If
echo         End While
echo         Return False
echo     End Function
echo.
echo     Sub New()
echo         Dim t As String = Nothing
echo         copy(t, tf_latest_changeset)
echo         If next_token(t, tf_latest_changeset_id) Then
echo             If next_token(t, tf_latest_changeset_user) Then
echo                 If next_token(t, tf_latest_changeset_date) Then
echo                     If Not String.IsNullOrEmpty(t) Then
echo                         tf_latest_changeset_comment = t.Trim()
echo                     End If
echo                 End If
echo             End If
echo         End If
echo.
echo         copy(t, tf_current_changeset)
echo         If next_token(t, tf_current_changeset_id) Then
echo             If next_token(t, tf_current_changeset_user) Then
echo                 If next_token(t, tf_current_changeset_date) Then
echo                     If Not String.IsNullOrEmpty(t) Then
echo                         tf_current_changeset_comment = t.Trim()
echo                     End If
echo                 End If
echo             End If
echo         End If
echo     End Sub
echo End Module

endlocal
